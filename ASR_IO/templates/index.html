<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceBridge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5b6af5;
            --secondary-color: #9747ff;
            --accent-color: #ffc75f;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --text-light: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 16px;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .app-logo {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-logo i {
            margin-right: 8px;
        }

        .app-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Screens */
        .screen {
            flex-grow: 1;
            display: none;
            flex-direction: column;
            padding: 16px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 1.3rem;
            margin-bottom: 16px;
            color: var(--primary-color);
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 12px;
            text-align: center;
            text-decoration: none;
        }

        .btn:hover, .btn:focus {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: var(--text-color);
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: var(--text-color);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(91, 106, 245, 0.25);
        }

        /* Welcome Screen */
        .welcome-title {
            text-align: center;
            font-size: 1.8rem;
            margin: 32px 0 16px;
            color: var(--primary-color);
        }

        .welcome-subtitle {
            text-align: center;
            margin-bottom: 36px;
            color: var(--text-light);
        }

        .welcome-illustration {
            width: 100%;
            max-width: 300px;
            margin: 10px auto 30px;
            display: block;
        }

        /* Chat Screen */
        .session-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #e9ecef;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
        }

        .session-id {
            font-weight: 500;
        }

        .connection-status {
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-dot.connected {
            background-color: var(--success-color);
        }

        .status-dot.disconnected {
            background-color: var(--danger-color);
        }

        .connection-quality {
            display: flex;
            margin-left: 10px;
            align-items: flex-end;
            height: 15px;
        }

        .connection-quality .bar {
            width: 3px;
            margin: 0 1px;
            background-color: #e1e1e1;
            border-radius: 1px;
        }

        .connection-quality .bar1 { height: 25%; }
        .connection-quality .bar2 { height: 50%; }
        .connection-quality .bar3 { height: 75%; }
        .connection-quality .bar4 { height: 100%; }

        .connection-quality .bar.active {
            background-color: var(--success-color);
        }

        .connection-quality.poor .bar.active {
            background-color: var(--danger-color);
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 300px;
        }

        .language-labels {
            display: flex;
            margin-bottom: 8px;
        }

        .language-label {
            flex: 1;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 4px;
            color: var(--text-light);
        }

        .chat-messages {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 12px;
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 200px;
        }

        .message {
            max-width: 80%;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 16px;
            position: relative;
            word-break: break-word;
        }

        .message.sent {
            align-self: flex-end;
            background-color: #e3f2fd;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background-color: #f1f1f1;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .continuation-message {
            text-align: center;
            padding: 8px;
            margin: 12px 0;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Quick Phrases */
        .quick-phrases {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .quick-phrase-header {
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            font-weight: 500;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
        }

        .quick-phrase-scroll {
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .quick-phrase-btn {
            background-color: #f1f1f1;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .quick-phrase-btn:hover {
            background-color: #e1e1e1;
        }

        /* Voice Visualization */
        .voice-waves {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 50px;
            margin-bottom: 20px;
        }

        .wave-bar {
            width: 4px;
            background-color: var(--primary-color);
            border-radius: 2px;
            animation: wave-animation 1s infinite ease-in-out;
        }

        .wave-bar:nth-child(1) { animation-delay: 0.0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave-animation {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }

        /* Microphone control */
        .mic-control {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            padding: 16px 0;
            position: relative;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 16px rgba(91, 106, 245, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .mic-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(91, 106, 245, 0.3);
        }

        .mic-button.recording {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, var(--danger-color), #ff6b6b);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.5);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }

        .mic-label {
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Text Input */
        .text-fallback {
            margin-top: 16px;
            text-align: center;
        }

        .input-group {
            display: flex;
            margin-top: 8px;
        }

        .input-group .form-input {
            flex-grow: 1;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            border-right: none;
        }

        .input-group .btn {
            margin-bottom: 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            width: auto;
        }

        /* Audio level indicators */
        .audio-levels {
            display: flex;
            margin-top: 16px;
            padding: 0 12px;
        }

        .audio-level {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background-color: #e9ecef;
            margin: 0 4px;
            position: relative;
            overflow: hidden;
        }

        .audio-level-fill {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 0%;
            transition: width 0.2s ease-out;
        }

        .input-level-fill {
            background-color: var(--primary-color);
        }

        .output-level-fill {
            background-color: var(--secondary-color);
        }

        /* Share link */
        .share-section {
            margin-top: 20px;
        }

        .share-link-container {
            display: flex;
            margin-top: 8px;
        }

        .share-link {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: 0.9rem;
            background-color: #f8f9fa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-button {
            padding: 12px;
            border: none;
            background-color: var(--accent-color);
            color: var(--text-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
        }

        .copy-button:active {
            opacity: 0.9;
        }

        /* Guidance text */
        .guidance-text {
            text-align: center;
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 50px;
            z-index: 1000;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 20px;
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(91, 106, 245, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 32px;
        }

        .loading-fact {
            max-width: 300px;
            text-align: center;
            color: var(--text-light);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-top: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tutorial */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tutorial-content {
            position: relative;
            max-width: 320px;
            width: 90%;
        }

        .tutorial-step {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .tutorial-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .tutorial-close-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .tutorial-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .tutorial-dots {
            display: flex;
            gap: 4px;
        }

        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e1e1e1;
        }

        .tutorial-dot.active {
            background-color: var(--primary-color);
        }

        /* Layout adjustments for larger screens */
        @media (min-width: 768px) {
            .app-container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="app-logo">
                <i class="fas fa-comment-dots"></i>
                <span>VoiceBridge</span>
            </div>
            <div class="app-subtitle">Real-time P2P Translation</div>
        </header>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active">
            <h1 class="welcome-title">Break Language Barriers</h1>
            <p class="welcome-subtitle">Speak in your language, hear in theirs</p>
            
            <!-- Illustration - replace with SVG in production -->
            <div style="text-align: center; margin: 20px 0;">
                <i class="fas fa-comments" style="font-size: 120px; color: var(--primary-color); opacity: 0.7;"></i>
            </div>
            
            <div class="card">
                <button id="create-button" class="btn">Create New Conversation</button>
                <button id="join-button" class="btn btn-secondary">Join Conversation</button>
            </div>
            
            <div class="guidance-text">
                <p>Create a conversation or join an existing one with a code.</p>
            </div>
        </div>

        <!-- Create Conversation Screen -->
        <div id="create-screen" class="screen">
            <div class="card">
                <h2 class="card-title">Create Conversation</h2>
                <form id="create-form">
                    <div class="form-group">
                        <label class="form-label" for="your-language">Your Language</label>
                        <select id="your-language" class="form-select" required>
                            <!-- Will be populated via JavaScript -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="their-language">Their Language</label>
                        <select id="their-language" class="form-select" required>
                            <!-- Will be populated via JavaScript -->
                        </select>
                    </div>
                    
                    <button type="submit" class="btn">Create</button>
                    <button type="button" id="back-from-create" class="btn btn-secondary">Back</button>
                </form>
            </div>
        </div>

        <!-- Join Conversation Screen -->
        <div id="join-screen" class="screen">
            <div class="card">
                <h2 class="card-title">Join Conversation</h2>
                <form id="join-form">
                    <div class="form-group">
                        <label class="form-label" for="session-id">Conversation Code</label>
                        <input type="text" id="session-id" class="form-input" placeholder="Enter code" required>
                    </div>
                    
                    <button type="submit" class="btn">Join Conversation</button>
                    <button type="button" id="back-from-join" class="btn btn-secondary">Back</button>
                </form>
            </div>
        </div>

        <!-- Conversation Screen -->
        <div id="translation-screen" class="screen">
            <div class="session-info">
                <div class="session-id">
                    Code: <span id="session-display">ABC123</span>
                </div>
                <div class="connection-status">
                    <div class="status-dot disconnected" id="connection-dot"></div>
                    <span id="connection-status">Waiting for partner...</span>
                    <div class="connection-quality" id="connection-quality">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                        <div class="bar bar4"></div>
                    </div>
                </div>
            </div>
            
            <div class="language-labels">
                <div class="language-label" id="your-language-label">English</div>
                <div class="language-label" id="their-language-label">Spanish</div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be added here via JavaScript -->
                </div>
            </div>
            
            <div class="audio-levels">
                <div class="audio-level">
                    <div class="audio-level-fill input-level-fill" id="input-level"></div>
                </div>
                <div class="audio-level">
                    <div class="audio-level-fill output-level-fill" id="output-level"></div>
                </div>
            </div>
            
            <div class="quick-phrases mt-3 mb-3">
                <div class="quick-phrase-header">
                    <i class="fas fa-bolt"></i> Quick Phrases
                    <button id="toggle-phrases" class="toggle-btn">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div id="quick-phrase-container" style="display: none;">
                    <div class="quick-phrase-scroll">
                        <button class="quick-phrase-btn">Hello, nice to meet you</button>
                        <button class="quick-phrase-btn">Could you speak slower please?</button>
                        <button class="quick-phrase-btn">I don't understand</button>
                        <button class="quick-phrase-btn">Thank you very much</button>
                        <button class="quick-phrase-btn">Where is the bathroom?</button>
                    </div>
                </div>
            </div>
            
            <div class="mic-control">
                <div class="voice-waves" id="voice-waves" style="display: none;">
                    <div class="wave-bar" style="height: 15px;"></div>
                    <div class="wave-bar" style="height: 25px;"></div>
                    <div class="wave-bar" style="height: 35px;"></div>
                    <div class="wave-bar" style="height: 25px;"></div>
                    <div class="wave-bar" style="height: 15px;"></div>
                </div>
                <button id="mic-button" class="mic-button">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="mic-label" id="mic-label">Hold to speak</div>
            </div>
            
            <div class="text-fallback mt-3">
                <button id="toggle-input-mode" class="btn btn-secondary btn-sm">
                    <i class="fas fa-keyboard"></i> Switch to Text Input
                </button>
                
                <div id="text-input-container" style="display: none;" class="mt-3">
                    <div class="input-group">
                        <input type="text" id="text-input" class="form-input" placeholder="Type your message...">
                        <button id="send-text-btn" class="btn">Send</button>
                    </div>
                </div>
            </div>
            
            <div class="share-section">
                <p>Share this code with your conversation partner:</p>
                <div class="share-link-container">
                    <div class="share-link" id="share-link">ABC123</div>
                    <button class="copy-button" id="copy-button">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <button id="leave-room-btn" class="btn btn-danger mt-4">
                <i class="fas fa-sign-out-alt"></i> Leave Conversation
            </button>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Initializing...</div>
        <div class="loading-fact" id="loading-fact"></div>
    </div>

    <!-- Tutorial overlay -->
    <div class="tutorial-overlay" id="tutorial-overlay" style="display: none;">
        <div class="tutorial-content">
            <div class="tutorial-step" id="tutorial-step">
                <div class="tutorial-header">
                    <h3 id="tutorial-title">Title</h3>
                    <button id="tutorial-close" class="tutorial-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="tutorial-text">Content goes here</div>
                <div class="tutorial-nav">
                    <button id="tutorial-prev" class="btn btn-sm btn-secondary">Previous</button>
                    <div id="tutorial-dots" class="tutorial-dots"></div>
                    <button id="tutorial-next" class="btn btn-sm">Next</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        // Define ISO language mappings
        const ISO_LANGUAGES = {
            "en": "English",
            "es": "Spanish",
            "fr": "French",
            "de": "German",
            "it": "Italian",
            "pt": "Portuguese",
            "ru": "Russian",
            "zh": "Chinese",
            "ja": "Japanese",
            "ko": "Korean",
            "ar": "Arabic",
            "hi": "Hindi",
            "bn": "Bengali",
            "sw": "Swahili",
            "ur": "Urdu",
            "vi": "Vietnamese",
            "te": "Telugu",
            "ta": "Tamil",
            "mr": "Marathi",
            "th": "Thai"
        };

        // Dictionary of quick phrases in different languages
        const quickPhrasesTranslations = {
            "en": [
                "Hello, nice to meet you",
                "Could you speak slower please?",
                "I don't understand",
                "Thank you very much",
                "Where is the bathroom?"
            ],
            "es": [
                "Hola, encantado de conocerte",
                "¿Podrías hablar más despacio, por favor?",
                "No entiendo",
                "Muchas gracias",
                "¿Dónde está el baño?"
            ],
            "fr": [
                "Bonjour, ravi de vous rencontrer",
                "Pourriez-vous parler plus lentement, s'il vous plaît?",
                "Je ne comprends pas",
                "Merci beaucoup",
                "Où sont les toilettes?"
            ],
            "de": [
                "Hallo, schön dich kennenzulernen",
                "Könntest du bitte langsamer sprechen?",
                "Ich verstehe nicht",
                "Vielen Dank",
                "Wo ist die Toilette?"
            ],
            "it": [
                "Ciao, piacere di conoscerti",
                "Potresti parlare più lentamente, per favore?",
                "Non capisco",
                "Grazie mille",
                "Dov'è il bagno?"
            ],
            "pt": [
                "Olá, prazer em conhecê-lo",
                "Poderia falar mais devagar, por favor?",
                "Eu não entendo",
                "Muito obrigado",
                "Onde fica o banheiro?"
            ],
            "ru": [
                "Здравствуйте, приятно познакомиться",
                "Вы не могли бы говорить помедленнее, пожалуйста?",
                "Я не понимаю",
                "Большое спасибо",
                "Где находится ванная комната?"
            ],
            "zh": [
                "你好，很高兴认识你",
                "你能说慢一点吗？",
                "我不明白",
                "非常感谢",
                "洗手间在哪里？"
            ],
            "ja": [
                "こんにちは、はじめまして",
                "もう少しゆっくり話していただけますか？",
                "わかりません",
                "どうもありがとうございます",
                "お手洗いはどこですか？"
            ],
            "ko": [
                "안녕하세요, 만나서 반갑습니다",
                "천천히 말씀해 주시겠어요?",
                "이해가 안 됩니다",
                "정말 감사합니다",
                "화장실이 어디에 있나요?"
            ],
            "ar": [
                "مرحبا، سعيد بلقائك",
                "هل يمكنك التحدث ببطء أكثر من فضلك؟",
                "أنا لا أفهم",
                "شكرا جزيلا",
                "أين الحمام؟"
            ],
            "hi": [
                "नमस्ते, आपसे मिलकर अच्छा लगा",
                "क्या आप धीरे बोल सकते हैं?",
                "मुझे समझ नहीं आया",
                "बहुत-बहुत धन्यवाद",
                "बाथरूम कहां है?"
            ],
            "bn": [
                "হ্যালো, আপনার সাথে দেখা করে ভালো লাগলো",
                "আপনি কি আরও ধীরে কথা বলতে পারেন?",
                "আমি বুঝতে পারছি না",
                "অনেক ধন্যবাদ",
                "বাথরুম কোথায়?"
            ],
            "sw": [
                "Hujambo, nimefurahi kukutana nawe",
                "Unaweza kuzungumza polepole tafadhali?",
                "Sielewi",
                "Asante sana",
                "Choo kiko wapi?"
            ],
            "ur": [
                "السلام علیکم، آپ سے مل کر خوشی ہوئی",
                "کیا آپ آہستہ بول سکتے ہیں؟",
                "مجھے سمجھ نہیں آ رہا",
                "بہت شکریہ",
                "باتھ روم کہاں ہے؟"
            ],
            "vi": [
                "Xin chào, rất vui được gặp bạn",
                "Bạn có thể nói chậm hơn được không?",
                "Tôi không hiểu",
                "Cảm ơn rất nhiều",
                "Nhà vệ sinh ở đâu?"
            ],
            "te": [
                "హలో, మిమ్మల్ని కలవడం చాలా సంతోషంగా ఉంది",
                "మీరు నెమ్మదిగా మాట్లాడగలరా?",
                "నాకు అర్థం కాలేదు",
                "చాలా ధన్యవాదాలు",
                "బాత్రూమ్ ఎక్కడ ఉంది?"
            ],
            "ta": [
                "வணக்கம், உங்களைச் சந்தித்ததில் மகிழ்ச்சி",
                "நீங்கள் மெதுவாகப் பேச முடியுமா?",
                "எனக்கு புரியவில்லை",
                "மிக்க நன்றி",
                "கழிவறை எங்கே?"
            ],
            "mr": [
                "नमस्कार, आपल्याला भेटून आनंद झाला",
                "तुम्ही हळू बोलू शकता का?",
                "मला समजत नाही",
                "खूप धन्यवाद",
                "बाथरूम कुठे आहे?"
            ],
            "th": [
                "สวัสดี ยินดีที่ได้รู้จัก",
                "คุณพูดช้าลงได้ไหม?",
                "ฉันไม่เข้าใจ",
                "ขอบคุณมาก",
                "ห้องน้ำอยู่ที่ไหน?"
            ]
        };
        
        // Helper function to get language code from name
        function getLanguageCode(languageName) {
            for (const [code, name] of Object.entries(ISO_LANGUAGES)) {
                if (name === languageName) {
                    return code;
                }
            }
            return "en"; // Default to English
        }
        
        // Function to update quick phrases based on language
        function updateQuickPhrases(languageCode) {
            // Default to English if language not found
            const phrases = quickPhrasesTranslations[languageCode] || quickPhrasesTranslations["en"];
            
            // Get all phrase buttons
            const phraseButtons = document.querySelectorAll('.quick-phrase-btn');
            
            // Update each button with the translated phrase
            phraseButtons.forEach((button, index) => {
                if (index < phrases.length) {
                    button.textContent = phrases[index];
                }
            });
            
            console.log(`Updated quick phrases to ${languageCode}`);
        }

        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const createScreen = document.getElementById('create-screen');
        const joinScreen = document.getElementById('join-screen');
        const translationScreen = document.getElementById('translation-screen');
        
        const createButton = document.getElementById('create-button');
        const joinButton = document.getElementById('join-button');
        const backFromCreateButton = document.getElementById('back-from-create');
        const backFromJoinButton = document.getElementById('back-from-join');
        
        const createForm = document.getElementById('create-form');
        const joinForm = document.getElementById('join-form');
        
        const yourLanguageSelect = document.getElementById('your-language');
        const theirLanguageSelect = document.getElementById('their-language');
        const sessionIdInput = document.getElementById('session-id');
        
        const micButton = document.getElementById('mic-button');
        const micLabel = document.getElementById('mic-label');
        const chatMessages = document.getElementById('chat-messages');
        const voiceWaves = document.getElementById('voice-waves');
        
        const sessionDisplay = document.getElementById('session-display');
        const connectionDot = document.getElementById('connection-dot');
        const connectionStatus = document.getElementById('connection-status');
        const connectionQuality = document.getElementById('connection-quality');
        const qualityBars = connectionQuality.querySelectorAll('.bar');
        
        const yourLanguageLabel = document.getElementById('your-language-label');
        const theirLanguageLabel = document.getElementById('their-language-label');
        
        const shareLink = document.getElementById('share-link');
        const copyButton = document.getElementById('copy-button');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        
        const inputLevel = document.getElementById('input-level');
        const outputLevel = document.getElementById('output-level');
        
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const loadingFact = document.getElementById('loading-fact');
        
        // Quick phrases
        const togglePhrasesBtn = document.getElementById('toggle-phrases');
        const quickPhraseContainer = document.getElementById('quick-phrase-container');
        const quickPhraseBtns = document.querySelectorAll('.quick-phrase-btn');
        
        // Text input
        const toggleInputBtn = document.getElementById('toggle-input-mode');
        const textInputContainer = document.getElementById('text-input-container');
        const textInput = document.getElementById('text-input');
        const sendTextBtn = document.getElementById('send-text-btn');
        
        // Tutorial elements
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialTitle = document.getElementById('tutorial-title');
        const tutorialText = document.getElementById('tutorial-text');
        const tutorialClose = document.getElementById('tutorial-close');
        const tutorialPrev = document.getElementById('tutorial-prev');
        const tutorialNext = document.getElementById('tutorial-next');
        const tutorialDots = document.getElementById('tutorial-dots');
        
        // Session state
        let sessionId = null;
        let userId = null;
        let userPosition = null;
        let socket = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let yourLanguage = 'Hindi';
        let theirLanguage = 'English';
        let pingInterval;
        
        // Mock audio level for demo
        let mockInputLevel = 0;
        let mockOutputLevel = 0;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch languages for dropdowns
            fetchLanguages();
            
            // Set up event listeners
            createButton.addEventListener('click', () => showScreen(createScreen));
            joinButton.addEventListener('click', () => showScreen(joinScreen));
            backFromCreateButton.addEventListener('click', () => showScreen(welcomeScreen));
            backFromJoinButton.addEventListener('click', () => showScreen(welcomeScreen));
            
            createForm.addEventListener('submit', handleCreateForm);
            joinForm.addEventListener('submit', handleJoinForm);
            
            micButton.addEventListener('mousedown', startRecording);
            micButton.addEventListener('mouseup', stopRecording);
            micButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startRecording();
            });
            micButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopRecording();
            });
            
            copyButton.addEventListener('click', copyShareCode);
            leaveRoomBtn.addEventListener('click', leaveRoom);
            
            // Quick phrases toggle
            togglePhrasesBtn.addEventListener('click', () => {
                if (quickPhraseContainer.style.display === 'none') {
                    quickPhraseContainer.style.display = 'block';
                    togglePhrasesBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
                } else {
                    quickPhraseContainer.style.display = 'none';
                    togglePhrasesBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                }
            });
            
            // Set up event listeners for all quick phrase buttons
            quickPhraseBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Use the text input sending mechanism
                    if (sessionId) {
                        socket.emit('text', {
                            session_id: sessionId,
                            user_id: userId,
                            text: btn.textContent
                        });
                        showToast('Quick phrase sent');
                    }
                });
            });
            
            // Text input toggle
            toggleInputBtn.addEventListener('click', () => {
                if (textInputContainer.style.display === 'none') {
                    textInputContainer.style.display = 'block';
                    toggleInputBtn.innerHTML = '<i class="fas fa-microphone"></i> Switch to Voice';
                } else {
                    textInputContainer.style.display = 'none';
                    toggleInputBtn.innerHTML = '<i class="fas fa-keyboard"></i> Switch to Text Input';
                }
            });
            
            sendTextBtn.addEventListener('click', sendTextMessage);
            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendTextMessage();
            });
            
            // Initialize socket connection
            initSocket();
            
            // Mock audio levels for demo
            setInterval(updateMockAudioLevels, 100);
            
            // Check URL for session info
            checkUrlParameters();
            
            // Load interesting facts
            loadRandomFacts();
            
            // Save conversation periodically
            setInterval(saveConversation, 30000); // Every 30 seconds
        });
        
        // Helper Functions
        function showScreen(screen) {
            welcomeScreen.classList.remove('active');
            createScreen.classList.remove('active');
            joinScreen.classList.remove('active');
            translationScreen.classList.remove('active');
            
            screen.classList.add('active');
            
            // Check for tutorial when showing translation screen
            if (screen === translationScreen) {
                checkTutorial();
            }
        }
        
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        function showLoading(show = true, message = 'Initializing...') {
            if (show) {
                loadingText.textContent = message;
                loadingOverlay.classList.add('show');
                showRandomFact();
            } else {
                loadingOverlay.classList.remove('show');
            }
        }
        
        const interestingFacts = [
            // Language facts
            "The average person spends 2 years of their life on the phone.",
            "There are over 7,000 languages spoken around the world today.",
            "English has borrowed words from over 350 other languages.",
            "A single conversation between two people contains about 1,000-2,000 words.",
            "Japanese has different words for 'blue' and 'green-blue'.",
            "Learning a second language can delay the onset of dementia by up to 4 years.",
            "The most common word in English is 'the'.",
            "The human brain processes speech at about 3 words per second.",
            "Sign language has its own grammar, syntax, and regional accents.",
            "Without speaking, humans can still express over 250,000 facial expressions.",
            "The longest word in English is 'pneumonoultramicroscopicsilicovolcanoconiosis'.",
            "The word 'set' has the highest number of definitions in the Oxford English Dictionary.",
            "Block by block, building something amazing...",
            "The journey of a thousand blocks begins with a single step.",
            "The End is just the beginning.",
            "Home is where your bed is."
        ];
        
        function loadRandomFacts() {
            // We've preloaded the facts array above
            console.log("Facts loaded:", interestingFacts.length);
        }
        
        function showRandomFact() {
            const randomIndex = Math.floor(Math.random() * interestingFacts.length);
            loadingFact.textContent = interestingFacts[randomIndex];
        }
        
        function updateMockAudioLevels() {
            if (isRecording) {
                mockInputLevel = Math.min(100, mockInputLevel + Math.random() * 20);
            } else {
                mockInputLevel = Math.max(0, mockInputLevel - 5);
            }
            
            // Randomly update output level
            if (Math.random() > 0.7) {
                mockOutputLevel = Math.min(100, mockOutputLevel + Math.random() * 30);
            } else {
                mockOutputLevel = Math.max(0, mockOutputLevel - 3);
            }
            
            inputLevel.style.width = `${mockInputLevel}%`;
            outputLevel.style.width = `${mockOutputLevel}%`;
        }
        
        async function fetchLanguages() {
            try {
                // Use our ISO_LANGUAGES object defined above
                const languages = ISO_LANGUAGES;
                
                // Populate dropdowns
                for (const [code, name] of Object.entries(languages)) {
                    const option1 = document.createElement('option');
                    option1.value = code;
                    option1.textContent = name;
                    
                    const option2 = document.createElement('option');
                    option2.value = code;
                    option2.textContent = name;
                    
                    yourLanguageSelect.appendChild(option1);
                    theirLanguageSelect.appendChild(option2);
                }
                
                // Default to Hindi for user, English for other
                yourLanguageSelect.value = 'hi';
                theirLanguageSelect.value = 'en';
                
                console.log("Setting default languages: Hindi -> English");
                console.log("Language values set to:", yourLanguageSelect.value, theirLanguageSelect.value);
            } catch (error) {
                console.error('Error fetching languages:', error);
                showToast('Failed to load languages. Please refresh the page.');
            }
        }
        
        async function handleCreateForm(e) {
            e.preventDefault();
            
            const userLang = yourLanguageSelect.value;
            const theirLang = theirLanguageSelect.value;
            
            yourLanguage = yourLanguageSelect.options[yourLanguageSelect.selectedIndex].text;
            theirLanguage = theirLanguageSelect.options[theirLanguageSelect.selectedIndex].text;
            
            // Update quick phrases based on user's language
            updateQuickPhrases(userLang);
            
            try {
                showLoading(true, 'Creating conversation...');
                
                const response = await fetch('/create-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user1_lang: userLang,
                        user2_lang: theirLang
                    })
                });
                
                showLoading(false);
                
                if (response.ok) {
                    const data = await response.json();
                    sessionId = data.session_id;
                    
                    // Join as user 1
                    joinSession(sessionId);
                } else {
                    const error = await response.json();
                    showToast(`Error: ${error.error || 'Failed to create session'}`);
                }
            } catch (error) {
                showLoading(false);
                console.error('Error creating session:', error);
                showToast('Network error. Please check your connection.');
            }
        }
        
        async function handleJoinForm(e) {
            e.preventDefault();
            
            const session = sessionIdInput.value.trim();
            
            if (!session) {
                showToast('Please enter a conversation code');
                return;
            }
            
            showLoading(true, 'Joining conversation...');
            joinSession(session);
        }
        
        async function joinSession(session) {
            try {
                // Try to join session, let server decide the position
                const response = await fetch(`/auto-join-session/${session}`);
                
                showLoading(false);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    sessionId = data.session_id;
                    userId = data.user_id;
                    userPosition = data.position;
                    
                    // Set language labels
                    if (userPosition === 1) {
                        yourLanguageLabel.textContent = data.your_language || yourLanguage;
                        theirLanguageLabel.textContent = data.their_language || theirLanguage;
                    } else {
                        // For position 2, languages are reversed
                        yourLanguageLabel.textContent = data.your_language || theirLanguage;
                        theirLanguageLabel.textContent = data.their_language || yourLanguage;
                    }
                    
                    // Get language code from label for quick phrases
                    const userLangCode = Object.keys(ISO_LANGUAGES).find(
                        code => ISO_LANGUAGES[code] === (data.your_language || yourLanguage)
                    ) || "en";
                    updateQuickPhrases(userLangCode);
                    
                    // Show translation screen
                    showScreen(translationScreen);
                    
                    // Update UI
                    sessionDisplay.textContent = sessionId;
                    shareLink.textContent = sessionId;
                    
                    // Connect to socket
                    socket.emit('join', {
                        session_id: sessionId,
                        user_id: userId
                    });
                    
                    // Start ping monitoring
                    startPingMonitoring();
                    
                    // Load previous conversation
                    loadConversation();
                    
                    showToast('Joined conversation successfully');
                } else {
                    const error = await response.json();
                    showToast(`Error: ${error.error || 'Failed to join session'}`);
                }
            } catch (error) {
                showLoading(false);
                console.error('Error joining session:', error);
                showToast('Network error. Please check your connection.');
            }
        }
        
        function leaveRoom() {
            if (socket && sessionId) {
                // Tell the server we're leaving
                socket.emit('leave', {
                    session_id: sessionId,
                    user_id: userId
                });
                
                // Reset state
                sessionId = null;
                userId = null;
                userPosition = null;
                
                // Clear chat messages
                chatMessages.innerHTML = '';
                
                // Clear ping interval
                clearInterval(pingInterval);
                
                // Return to welcome screen
                showScreen(welcomeScreen);
                showToast('You left the conversation');
            }
        }
        
        function initSocket() {
            // Initialize Socket.IO connection
            socket = io();
            
            // Set up event handlers
            socket.on('connect', () => {
                console.log('Connected to server');
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                connectionDot.classList.remove('connected');
                connectionDot.classList.add('disconnected');
                connectionStatus.textContent = 'Disconnected from server';
                updateConnectionQuality(0);
            });
            
            socket.on('joined', (data) => {
                console.log('Joined session:', data);
                
                if (data.other_user_connected) {
                    connectionDot.classList.remove('disconnected');
                    connectionDot.classList.add('connected');
                    connectionStatus.textContent = 'Partner connected';
                    showToast('Your conversation partner has joined');
                }
            });
            
            socket.on('user_joined', (data) => {
                console.log('Other user joined:', data);
                connectionDot.classList.remove('disconnected');
                connectionDot.classList.add('connected');
                connectionStatus.textContent = 'Partner connected';
                showToast('Your conversation partner has joined');
            });
            
            socket.on('text_update', (data) => {
                console.log('Text update:', data);
                updateChatMessages(data);
            });
            
            socket.on('audio_update', (data) => {
                console.log('Audio update received');
                playAudio(data.audio);
                
                // Simulate output level for incoming audio
                mockOutputLevel = 90;
            });
            
            socket.on('user_left', (data) => {
                console.log('User left:', data);
                connectionDot.classList.remove('connected');
                connectionDot.classList.add('disconnected');
                connectionStatus.textContent = 'Partner disconnected';
                showToast('Your conversation partner left');
            });
            
            socket.on('error', (data) => {
                console.error('Socket error:', data.message);
                showToast(`Error: ${data.message}`);
            });
            
            socket.on('pong', () => {
                // Used for connection quality monitoring
            });
        }
        
        function startPingMonitoring() {
            let pingTimes = [];
            
            pingInterval = setInterval(() => {
                if (!socket || !socket.connected) {
                    updateConnectionQuality(0);
                    return;
                }
                
                const start = Date.now();
                socket.emit('ping', {}, () => {
                    const latency = Date.now() - start;
                    pingTimes.push(latency);
                    
                    // Keep only the last 3 ping times
                    if (pingTimes.length > 3) {
                        pingTimes.shift();
                    }
                    
                    // Calculate average latency
                    const avgLatency = pingTimes.reduce((sum, time) => sum + time, 0) / pingTimes.length;
                    
                    // Set quality based on latency
                    let quality;
                    if (avgLatency < 100) quality = 4;
                    else if (avgLatency < 200) quality = 3;
                    else if (avgLatency < 400) quality = 2;
                    else quality = 1;
                    
                    updateConnectionQuality(quality);
                });
            }, 5000);
        }
        
        function updateConnectionQuality(quality) {
            // quality should be a number from 0-4
            // 0 = disconnected, 4 = excellent
            
            // Reset all bars
            qualityBars.forEach(bar => bar.classList.remove('active'));
            
            // Set poor class if quality is low
            if (quality <= 1) {
                connectionQuality.classList.add('poor');
            } else {
                connectionQuality.classList.remove('poor');
            }
            
            // Activate the appropriate number of bars
            for (let i = 0; i < quality; i++) {
                if (i < qualityBars.length) {
                    qualityBars[i].classList.add('active');
                }
            }
        }
        
        // Replace your current updateChatMessages function with this:
function updateChatMessages(data) {
    // Current timestamp
    const now = new Date();
    const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    if (data.type === 'source') {
        // For source messages (your messages), create a NEW element each time
        const messageEl = document.createElement('div');
        messageEl.className = 'message sent';
        
        // Message content
        messageEl.innerHTML = `
            <div>${data.text}</div>
            <div class="message-time">${time}</div>
        `;
        
        // Add to chat
        chatMessages.appendChild(messageEl);
    } else if (data.type === 'translation') {
        // For translations (their messages), create a NEW element each time
        const messageEl = document.createElement('div');
        messageEl.className = 'message received';
        
        // Message content
        messageEl.innerHTML = `
            <div>${data.text}</div>
            <div class="message-time">${time}</div>
        `;
        
        // Add to chat
        chatMessages.appendChild(messageEl);
    }
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
        }
            async function startRecording() {
                if (isRecording || !socket || !socket.connected || !sessionId) return;
            
             try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('stop', () => {
                    processAudioChunks();
                });
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                micButton.classList.add('recording');
                micLabel.textContent = 'Release to stop';
                voiceWaves.style.display = 'flex'; // Show voice waves
            } catch (error) {
                console.error('Error starting recording:', error);
                showToast('Microphone access denied. Please check permissions.');
            }
        }
        
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            mediaRecorder.stop();
            isRecording = false;
            
            // Update UI
            micButton.classList.remove('recording');
            micLabel.textContent = 'Hold to speak';
            voiceWaves.style.display = 'none'; // Hide voice waves
        }
        
        async function processAudioChunks() {
            if (audioChunks.length === 0) return;
            
            try {
                // Create blob from chunks
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                
                // Convert to Float32Array
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioData = await decodeAudioData(arrayBuffer);
                
                // Convert to base64
                const audio_b64 = arrayBufferToBase64(audioData.buffer);
                
                // Send to server
                socket.emit('audio', {
                    session_id: sessionId,
                    user_id: userId,
                    audio: audio_b64
                });
            } catch (error) {
                console.error('Error processing audio:', error);
                showToast('Error processing audio');
            }
        }
        
        function sendTextMessage() {
            if (!textInput.value.trim() || !sessionId) return;
            
            // Send text to server
            socket.emit('text', {
                session_id: sessionId,
                user_id: userId,
                text: textInput.value.trim()
            });
            
            // Clear input
            textInput.value = '';
        }
        
        async function decodeAudioData(arrayBuffer) {
            // Create audio context
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Decode audio data
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            // Get first channel data
            const audioData = audioBuffer.getChannelData(0);
            
            // Resample to 16kHz if needed
            if (audioBuffer.sampleRate !== 16000) {
                return resampleAudio(audioData, audioBuffer.sampleRate, 16000);
            }
            
            return audioData;
        }
        
        function resampleAudio(audioData, originalSampleRate, targetSampleRate) {
            const ratio = targetSampleRate / originalSampleRate;
            const newLength = Math.floor(audioData.length * ratio);
            const result = new Float32Array(newLength);
            
            for (let i = 0; i < newLength; i++) {
                const index = Math.floor(i / ratio);
                result[i] = audioData[index];
            }
            
            return result;
        }
        
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            const binary = bytes.reduce((acc, byte) => acc + String.fromCharCode(byte), '');
            return window.btoa(binary);
        }
        
        function playAudio(audio_b64) {
            if (!audio_b64) return;
            
            try {
                // Decode base64
                const binaryString = window.atob(audio_b64);
                const bytes = new Uint8Array(binaryString.length);
                
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Convert to audio buffer
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = new Int16Array(bytes.buffer);
                const floatBuffer = new Float32Array(audioBuffer.length);
                
                // Convert Int16 to Float32
                for (let i = 0; i < audioBuffer.length; i++) {
                    floatBuffer[i] = audioBuffer[i] / 32767.0;
                }
                
                // Create buffer source
                const bufferSource = audioContext.createBuffer(1, floatBuffer.length, 16000);
                bufferSource.getChannelData(0).set(floatBuffer);
                
                // Play audio
                const source = audioContext.createBufferSource();
                source.buffer = bufferSource;
                source.connect(audioContext.destination);
                source.start();
            } catch (error) {
                console.error('Error playing audio:', error);
                showToast('Error playing audio');
            }
        }
        
        function copyShareCode() {
            navigator.clipboard.writeText(sessionId)
                .then(() => {
                    showToast('Conversation code copied to clipboard');
                })
                .catch(err => {
                    console.error('Error copying text: ', err);
                    showToast('Failed to copy code');
                });
        }
        
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const session = urlParams.get('session');
            
            if (session) {
                sessionIdInput.value = session;
                showScreen(joinScreen);
            }
        }
        
        // Conversation persistence
        function saveConversation() {
            if (!sessionId) return;
            
            // Get all message elements
            const messages = chatMessages.querySelectorAll('.message');
            
            // Create an array of message objects
            const conversationData = Array.from(messages).map(msg => {
                return {
                    type: msg.classList.contains('sent') ? 'sent' : 'received',
                    text: msg.querySelector('div:first-child').textContent,
                    time: msg.querySelector('.message-time').textContent
                };
            });
            
            // Save conversation data with sessionId as key
            localStorage.setItem(`conversation_${sessionId}`, JSON.stringify({
                messages: conversationData,
                timestamp: new Date().toISOString(),
                yourLanguage: yourLanguageLabel.textContent,
                theirLanguage: theirLanguageLabel.textContent
            }));
        }
        
        // Load previous conversation when joining
        function loadConversation() {
            if (!sessionId) return;
            
            // Check if there's a saved conversation
            const savedData = localStorage.getItem(`conversation_${sessionId}`);
            if (!savedData) return;
            
            try {
                const conversation = JSON.parse(savedData);
                
                // Add a timestamp indicator
                const timestamp = new Date(conversation.timestamp);
                const formattedDate = timestamp.toLocaleDateString();
                const formattedTime = timestamp.toLocaleTimeString();
                
                // Add a continuation message
                const continuationEl = document.createElement('div');
                continuationEl.className = 'continuation-message';
                continuationEl.textContent = `Continuing conversation from ${formattedDate} ${formattedTime}`;
                chatMessages.appendChild(continuationEl);
                
                // Restore messages
                conversation.messages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${msg.type}`;
                    messageEl.innerHTML = `
                        <div>${msg.text}</div>
                        <div class="message-time">${msg.time}</div>
                    `;
                    chatMessages.appendChild(messageEl);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                showToast('Previous conversation loaded');
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }
        
        // Tutorial functionality
        function showTutorial() {
            // Tutorial steps
            const steps = [
                {
                    element: '#mic-button',
                    title: 'Hold to Speak',
                    content: 'Press and hold this button while you speak, then release when done.'
                },
                {
                    element: '.chat-messages',
                    title: 'Conversation Area',
                    content: 'Your messages appear on the right, translations on the left.'
                },
                {
                    element: '#share-link',
                    title: 'Share Code',
                    content: 'Share this code with your conversation partner to connect.'
                },
                {
                    element: '#toggle-input-mode',
                    title: 'Text Input',
                    content: 'If speaking isn\'t an option, you can switch to typing.'
                },
                {
                    element: '.quick-phrases',
                    title: 'Quick Phrases',
                    content: 'Use these common phrases for fast communication.'
                }
            ];
            
            let currentStep = 0;
            
            // Create dots
            tutorialDots.innerHTML = '';
            steps.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'tutorial-dot' + (index === 0 ? ' active' : '');
                tutorialDots.appendChild(dot);
            });
            
            // Show first step
            showStep(0);
            
            // Show overlay
            tutorialOverlay.style.display = 'flex';
            
            // Event listeners
            tutorialClose.addEventListener('click', () => {
                tutorialOverlay.style.display = 'none';
                localStorage.setItem('tutorial-shown', 'true');
            });
            
            tutorialPrev.addEventListener('click', () => {
                if (currentStep > 0) {
                    showStep(currentStep - 1);
                }
            });
            
            tutorialNext.addEventListener('click', () => {
                if (currentStep < steps.length - 1) {
                    showStep(currentStep + 1);
                } else {
                    tutorialOverlay.style.display = 'none';
                    localStorage.setItem('tutorial-shown', 'true');
                }
            });
            
            function showStep(stepIndex) {
                currentStep = stepIndex;
                const step = steps[stepIndex];
                
                // Update content
                tutorialTitle.textContent = step.title;
                tutorialText.textContent = step.content;
                
                // Update buttons
                tutorialPrev.style.visibility = stepIndex === 0 ? 'hidden' : 'visible';
                tutorialNext.textContent = stepIndex === steps.length - 1 ? 'Finish' : 'Next';
                
                // Update dots
                const dots = tutorialDots.querySelectorAll('.tutorial-dot');
                dots.forEach((dot, i) => {
                    dot.className = 'tutorial-dot' + (i === stepIndex ? ' active' : '');
                });
            }
        }
        
        // Check if user has seen the tutorial
        function checkTutorial() {
            // Only show tutorial in translation screen
            if (translationScreen.classList.contains('active')) {
                const tutorialShown = localStorage.getItem('tutorial-shown');
                if (!tutorialShown) {
                    // Wait a moment to let the screen render
                    setTimeout(showTutorial, 1000);
                }
            }
        }
    </script>
</body>
</html>